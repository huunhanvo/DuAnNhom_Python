{% extends 'customer/base_customer.html' %}
{% load static %}

{% block title %}Tài khoản của tôi - Barbershop Hoàng Gia{% endblock %}

{% block content %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                {% include 'customer/includes/dashboard_sidebar.html' with active='profile' %}
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Page Header -->
                <div class="mb-4">
                    <h3 class="fw-bold mb-1">Thông Tin Tài Khoản</h3>
                    <p class="text-muted mb-0">Quản lý thông tin cá nhân của bạn</p>
                </div>

                <!-- Profile Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">Thông tin cá nhân</h5>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="editProfileBtn">
                                <i class="fas fa-edit me-1"></i> Chỉnh sửa
                            </button>
                        </div>

                        <form id="profileForm" method="POST" action="{% url 'core:update_profile' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <!-- Avatar -->
                            <div class="text-center mb-4">
                                <div class="position-relative d-inline-block">
                                    {% if user.anh_dai_dien %}
                                    <img src="{{ user.anh_dai_dien }}" alt="{{ user.ho_ten }}" 
                                         class="rounded-circle" id="avatarPreview" 
                                         style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #d4af37;">
                                    {% else %}
                                    <div class="rounded-circle bg-warning text-white d-inline-flex align-items-center justify-content-center"
                                         id="avatarPreview"
                                         style="width: 120px; height: 120px; font-size: 3rem; border: 4px solid #d4af37;">
                                        {{ user.ho_ten|slice:":1"|upper }}
                                    </div>
                                    {% endif %}
                                    <label for="avatarInput" class="avatar-upload-btn" style="display: none;">
                                        <i class="fas fa-camera"></i>
                                        <input type="file" id="avatarInput" name="anh_dai_dien" accept="image/*" class="d-none">
                                    </label>
                                </div>
                            </div>

                            <!-- Personal Info -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="ho_ten" class="form-label fw-bold">Họ và tên</label>
                                    <input type="text" class="form-control" id="ho_ten" name="ho_ten" 
                                           value="{{ user.ho_ten }}" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label for="so_dien_thoai" class="form-label fw-bold">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="so_dien_thoai" name="so_dien_thoai" 
                                           value="{{ user.so_dien_thoai }}" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label for="email" class="form-label fw-bold">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ user.email }}" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label for="ngay_sinh" class="form-label fw-bold">Ngày sinh</label>
                                    <input type="date" class="form-control" id="ngay_sinh" name="ngay_sinh" 
                                           value="{{ user.ngay_sinh|date:'Y-m-d' }}" readonly>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Giới tính</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gioi_tinh" 
                                                   id="nam" value="nam" {% if user.gioi_tinh == 'nam' %}checked{% endif %} disabled>
                                            <label class="form-check-label" for="nam">Nam</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gioi_tinh" 
                                                   id="nu" value="nu" {% if user.gioi_tinh == 'nu' %}checked{% endif %} disabled>
                                            <label class="form-check-label" for="nu">Nữ</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gioi_tinh" 
                                                   id="khac" value="khac" {% if user.gioi_tinh == 'khac' %}checked{% endif %} disabled>
                                            <label class="form-check-label" for="khac">Khác</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="dia_chi" class="form-label fw-bold">Địa chỉ</label>
                                    <textarea class="form-control" id="dia_chi" name="dia_chi" rows="2" readonly>{{ user.dia_chi }}</textarea>
                                </div>
                            </div>

                            <!-- Save Button (Hidden initially) -->
                            <div class="mt-4 d-none" id="saveButtonContainer">
                                <hr>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-gold">
                                        <i class="fas fa-save me-2"></i> Lưu thay đổi
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn">
                                        Hủy
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Security Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">Bảo mật</h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Mật khẩu</label>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <span class="text-muted">••••••••••••</span>
                                <a href="{% url 'core:change_password' %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-key"></i> Đổi mật khẩu
                                </a>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Xác thực hai yếu tố</label>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <span class="text-muted">
                                    {% if user.two_factor_enabled %}
                                    <i class="fas fa-shield-alt text-success me-2"></i> Đã bật
                                    {% else %}
                                    <i class="fas fa-shield-alt text-muted me-2"></i> Chưa bật
                                    {% endif %}
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-primary">
                                    {% if user.two_factor_enabled %}Tắt{% else %}Bật{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Stats -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">Thống kê tài khoản</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <i class="fas fa-calendar-check text-primary fa-2x mb-2"></i>
                                    <h4 class="fw-bold mb-1">{{ total_bookings }}</h4>
                                    <p class="text-muted small mb-0">Lần đặt lịch</p>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="stat-box">
                                    <i class="fas fa-money-bill-wave text-success fa-2x mb-2"></i>
                                    <h4 class="fw-bold mb-1">{{ total_spent|floatformat:0 }}đ</h4>
                                    <p class="text-muted small mb-0">Tổng chi tiêu</p>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="stat-box">
                                    <i class="fas fa-user-clock text-warning fa-2x mb-2"></i>
                                    <h4 class="fw-bold mb-1">{{ days_member }}</h4>
                                    <p class="text-muted small mb-0">Ngày thành viên</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card border-danger shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3 text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i> Vùng nguy hiểm
                        </h5>
                        <p class="text-muted mb-3">
                            Một khi bạn xóa tài khoản, sẽ không thể khôi phục. Hãy cân nhắc kỹ.
                        </p>
                        <button type="button" class="btn btn-outline-danger" id="deleteAccountBtn">
                            <i class="fas fa-trash me-2"></i> Xóa tài khoản
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Xác nhận xóa tài khoản</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Cảnh báo!</strong> Hành động này không thể hoàn tác.
                </div>
                <p>Khi xóa tài khoản, bạn sẽ mất:</p>
                <ul>
                    <li>Tất cả lịch sử đặt lịch</li>
                    <li>Điểm tích lũy và voucher</li>
                    <li>Thông tin cá nhân</li>
                </ul>
                <div class="mb-3">
                    <label for="confirmDelete" class="form-label">
                        Nhập <strong>"XÓA TÀI KHOẢN"</strong> để xác nhận:
                    </label>
                    <input type="text" class="form-control" id="confirmDelete" placeholder="XÓA TÀI KHOẢN">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Xóa tài khoản</button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-upload-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 40px;
    height: 40px;
    background: #d4af37;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
}

.avatar-upload-btn:hover {
    background: #8b7355;
    transform: scale(1.1);
}

.stat-box {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let originalFormData = $('#profileForm').serialize();
    let isEditing = false;

    // Edit profile
    $('#editProfileBtn').click(function() {
        isEditing = true;
        $('#profileForm input, #profileForm textarea, #profileForm .form-check-input').prop('readonly', false).prop('disabled', false);
        $('.avatar-upload-btn').show();
        $('#saveButtonContainer').removeClass('d-none');
        $(this).hide();
    });

    // Cancel edit
    $('#cancelEditBtn').click(function() {
        isEditing = false;
        location.reload();
    });

    // Avatar preview
    $('#avatarInput').change(function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#avatarPreview').attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    // Delete account modal
    $('#deleteAccountBtn').click(function() {
        const modal = new bootstrap.Modal('#deleteAccountModal');
        modal.show();
    });

    // Confirm delete validation
    $('#confirmDelete').on('input', function() {
        const value = $(this).val();
        $('#confirmDeleteBtn').prop('disabled', value !== 'XÓA TÀI KHOẢN');
    });

    // Confirm delete
    $('#confirmDeleteBtn').click(function() {
        alert('Tính năng xóa tài khoản tạm thời chưa khả dụng. Vui lòng liên hệ quản trị viên.');
        $('#deleteAccountModal').modal('hide');
        /* TODO: Implement delete account
        $.ajax({
            url: '/customer/delete-account/',
            method: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    window.location.href = '{% url "core:home" %}';
                } else {
                    alert(response.message || 'Có lỗi xảy ra');
                }
            }
        });
        */
    });

    // Warn before leaving if editing
    $(window).on('beforeunload', function() {
        if (isEditing && $('#profileForm').serialize() !== originalFormData) {
            return 'Bạn có thay đổi chưa được lưu. Bạn có chắc muốn rời đi?';
        }
    });
});
</script>
{% endblock %}
