{% extends 'customer/base_customer.html' %}
{% load static %}

{% block title %}Đặt lịch - Bước 1: Chọn dịch vụ{% endblock %}

{% block content %}
<section class="py-5 bg-light">
    <div class="container">
        <!-- Booking Wizard -->
        <div class="booking-wizard mb-5">
            <div class="wizard-step active">
                <div class="step-number">1</div>
                <div class="step-title">Chọn dịch vụ</div>
            </div>
            <div class="wizard-step">
                <div class="step-number">2</div>
                <div class="step-title">Chọn stylist & thời gian</div>
            </div>
            <div class="wizard-step">
                <div class="step-number">3</div>
                <div class="step-title">Xác nhận & Hoàn tất</div>
            </div>
        </div>

        <div class="row">
            <!-- Service Selection -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h4 class="mb-0">
                            <i class="fas fa-cut me-2 text-warning"></i> Chọn dịch vụ
                        </h4>
                        <p class="text-muted small mb-0 mt-2">
                            Bạn có thể chọn nhiều dịch vụ cùng lúc
                        </p>
                    </div>
                    <div class="card-body p-4">
                        <!-- Category Tabs -->
                        <ul class="nav nav-pills mb-4" id="categoryTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-tab" data-bs-toggle="pill" 
                                        data-bs-target="#all" type="button" role="tab">
                                    Tất cả
                                </button>
                            </li>
                            {% for category in categories %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cat{{ category.id }}-tab" data-bs-toggle="pill" 
                                        data-bs-target="#cat{{ category.id }}" type="button" role="tab">
                                    {{ category.ten_danh_muc }}
                                </button>
                            </li>
                            {% endfor %}
                        </ul>

                        <!-- Services List -->
                        <div class="tab-content" id="servicesTabContent">
                            <div class="tab-pane fade show active" id="all" role="tabpanel">
                                <div class="services-list">
                                    {% for service in services %}
                                    <div class="service-item" data-service-id="{{ service.id }}">
                                        <div class="form-check">
                                            <input class="form-check-input service-checkbox" type="checkbox" 
                                                   value="{{ service.id }}" id="service{{ service.id }}"
                                                   data-price="{{ service.gia }}" 
                                                   data-duration="{{ service.thoi_gian_thuc_hien }}"
                                                   data-name="{{ service.ten_dich_vu }}">
                                            <label class="form-check-label w-100" for="service{{ service.id }}">
                                                <div class="d-flex align-items-center">
                                                    {% if service.anh_minh_hoa %}
                                                    <img src="{{ service.anh_minh_hoa }}" alt="{{ service.ten_dich_vu }}" 
                                                         class="service-img me-3">
                                                    {% else %}
                                                    <div class="service-img-placeholder me-3">
                                                        <i class="fas fa-cut"></i>
                                                    </div>
                                                    {% endif %}
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">{{ service.ten_dich_vu }}</h6>
                                                        <p class="text-muted small mb-2">{{ service.mo_ta_ngan|truncatewords:15 }}</p>
                                                        <div class="d-flex align-items-center gap-3">
                                                            <span class="badge bg-success">
                                                                <i class="fas fa-money-bill-wave me-1"></i>
                                                                {{ service.gia|floatformat:0 }}đ
                                                            </span>
                                                            <span class="badge bg-info">
                                                                <i class="far fa-clock me-1"></i>
                                                                {{ service.thoi_gian_thuc_hien }} phút
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p>Không có dịch vụ nào</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            {% for category in categories %}
                            <div class="tab-pane fade" id="cat{{ category.id }}" role="tabpanel">
                                <div class="services-list">
                                    {% for service in services %}
                                    {% if service.danh_muc.id == category.id %}
                                    <div class="service-item" data-service-id="{{ service.id }}">
                                        <div class="form-check">
                                            <input class="form-check-input service-checkbox" type="checkbox" 
                                                   value="{{ service.id }}" id="service{{ service.id }}_{{ category.id }}"
                                                   data-price="{{ service.gia }}" 
                                                   data-duration="{{ service.thoi_gian_thuc_hien }}"
                                                   data-name="{{ service.ten_dich_vu }}">
                                            <label class="form-check-label w-100" for="service{{ service.id }}_{{ category.id }}">
                                                <div class="d-flex align-items-center">
                                                    {% if service.anh_minh_hoa %}
                                                    <img src="{{ service.anh_minh_hoa }}" alt="{{ service.ten_dich_vu }}" 
                                                         class="service-img me-3">
                                                    {% else %}
                                                    <div class="service-img-placeholder me-3">
                                                        <i class="fas fa-cut"></i>
                                                    </div>
                                                    {% endif %}
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">{{ service.ten_dich_vu }}</h6>
                                                        <p class="text-muted small mb-2">{{ service.mo_ta_ngan|truncatewords:15 }}</p>
                                                        <div class="d-flex align-items-center gap-3">
                                                            <span class="badge bg-success">
                                                                <i class="fas fa-money-bill-wave me-1"></i>
                                                                {{ service.gia|floatformat:0 }}đ
                                                            </span>
                                                            <span class="badge bg-info">
                                                                <i class="far fa-clock me-1"></i>
                                                                {{ service.thoi_gian_thuc_hien }} phút
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Popular Combos -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">
                            <i class="fas fa-fire text-danger me-2"></i> Combo phổ biến
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            {% for combo in popular_combos %}
                            <div class="col-md-6">
                                <div class="combo-card" data-combo-id="{{ combo.id }}">
                                    <h6 class="fw-bold mb-2">{{ combo.ten }}</h6>
                                    <p class="text-muted small mb-2">{{ combo.mo_ta }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-success fw-bold">
                                                {{ combo.gia|floatformat:0 }}đ
                                            </span>
                                            {% if combo.gia_goc %}
                                            <span class="text-muted text-decoration-line-through small ms-2">
                                                {{ combo.gia_goc|floatformat:0 }}đ
                                            </span>
                                            {% endif %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary select-combo">
                                            Chọn
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12 text-center text-muted">
                                <p class="mb-0">Chưa có combo nào</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Sidebar -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-header bg-warning text-dark py-3">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i> Dịch vụ đã chọn
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="selectedServices">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-hand-pointer fa-2x mb-2"></i>
                                <p class="small mb-0">Chọn dịch vụ bên trái</p>
                            </div>
                        </div>

                        <hr class="my-3">

                        <!-- Summary -->
                        <div class="booking-summary">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Số dịch vụ:</span>
                                <strong id="serviceCount">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Thời gian:</span>
                                <strong id="totalDuration">0 phút</strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="fw-bold">Tổng tiền:</span>
                                <strong class="text-success fs-5" id="totalPrice">0đ</strong>
                            </div>

                            <button type="button" class="btn btn-gold w-100" id="nextBtn" disabled>
                                Tiếp tục <i class="fas fa-arrow-right ms-2"></i>
                            </button>

                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Giá có thể thay đổi tùy theo thợ
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedServices = [];

    // Service checkbox change
    $('.service-checkbox').change(function() {
        const serviceId = $(this).val();
        const serviceName = $(this).data('name');
        const servicePrice = parseFloat($(this).data('price'));
        const serviceDuration = parseInt($(this).data('duration'));

        if ($(this).is(':checked')) {
            selectedServices.push({
                id: serviceId,
                name: serviceName,
                price: servicePrice,
                duration: serviceDuration
            });
        } else {
            selectedServices = selectedServices.filter(s => s.id !== serviceId);
        }

        updateSummary();
    });

    // Combo selection
    $('.select-combo').click(function() {
        const comboCard = $(this).closest('.combo-card');
        const comboId = comboCard.data('combo-id');
        
        // Uncheck all services
        $('.service-checkbox').prop('checked', false);
        selectedServices = [];
        
        // Check services in combo (implement based on your combo structure)
        // This is a placeholder - adjust based on your data
        showAlert('Combo đã được chọn', 'success');
        updateSummary();
    });

    // Update summary
    function updateSummary() {
        const count = selectedServices.length;
        const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
        const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);

        $('#serviceCount').text(count);
        $('#totalDuration').text(totalDuration + ' phút');
        $('#totalPrice').text(formatMoney(totalPrice));

        // Enable/disable next button
        $('#nextBtn').prop('disabled', count === 0);

        // Update selected services list
        if (count === 0) {
            $('#selectedServices').html(`
                <div class="text-center text-muted py-4">
                    <i class="fas fa-hand-pointer fa-2x mb-2"></i>
                    <p class="small mb-0">Chọn dịch vụ bên trái</p>
                </div>
            `);
        } else {
            let html = '';
            selectedServices.forEach(service => {
                html += `
                    <div class="selected-service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small">${service.name}</h6>
                                <span class="badge bg-light text-dark">
                                    ${formatMoney(service.price)}
                                </span>
                            </div>
                            <button type="button" class="btn btn-sm btn-link text-danger p-0" 
                                    onclick="removeService('${service.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            $('#selectedServices').html(html);
        }
    }

    // Remove service
    window.removeService = function(serviceId) {
        $(`#service${serviceId}`).prop('checked', false).trigger('change');
    };

    // Next button - Submit form to step 2
    $('#nextBtn').click(function() {
        if (selectedServices.length === 0) {
            showAlert('Vui lòng chọn ít nhất 1 dịch vụ', 'warning');
            return;
        }

        // Save to session storage for backup
        sessionStorage.setItem('selectedServices', JSON.stringify(selectedServices));
        
        // Create form and submit to step 2
        const form = $('<form>', {
            'method': 'POST',
            'action': "{% url 'bookings:booking_step2' %}"
        });
        
        // Add CSRF token
        form.append($('<input>', {
            'type': 'hidden',
            'name': 'csrfmiddlewaretoken',
            'value': '{{ csrf_token }}'
        }));
        
        // Add services as JSON
        form.append($('<input>', {
            'type': 'hidden',
            'name': 'services',
            'value': JSON.stringify(selectedServices)
        }));
        
        // Append form to body and submit
        $('body').append(form);
        form.submit();
    });

    // Format money
    function formatMoney(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    // Show alert
    function showAlert(message, type) {
        // Implementation from customer.js
        const alert = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('body').prepend(alert);
        setTimeout(() => $('.alert').alert('close'), 3000);
    }
});
</script>
{% endblock %}
