{% extends 'customer/base_customer.html' %}
{% load static %}

{% block title %}Lịch sử dịch vụ - Barbershop Hoàng Gia{% endblock %}

{% block content %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                {% include 'customer/includes/dashboard_sidebar.html' with active='history' %}
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Page Header -->
                <div class="mb-4">
                    <h3 class="fw-bold mb-1">Lịch Sử Dịch Vụ</h3>
                    <p class="text-muted mb-0">Xem lại tất cả các lần sử dụng dịch vụ</p>
                </div>

                <!-- Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card-simple bg-success text-white">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h3>{{ total_completed }}</h3>
                            <p class="mb-0">Lần hoàn thành</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card-simple bg-warning text-dark">
                            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                            <h3>{{ total_spent|floatformat:0 }}đ</h3>
                            <p class="mb-0">Tổng chi tiêu</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card-simple bg-info text-white">
                            <i class="fas fa-star fa-2x mb-2"></i>
                            <h3>{{ average_rating|floatformat:1 }}</h3>
                            <p class="mb-0">Đánh giá trung bình</p>
                        </div>
                    </div>
                </div>

                <!-- Filter & Search -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-3">
                        <form method="GET" class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small">Từ ngày</label>
                                <input type="date" class="form-control" name="from_date" 
                                       value="{{ request.GET.from_date }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Đến ngày</label>
                                <input type="date" class="form-control" name="to_date" 
                                       value="{{ request.GET.to_date }}">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-2"></i> Lọc
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- History List -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        {% if history_list %}
                        <div class="history-timeline">
                            {% for booking in history_list %}
                            <div class="history-item">
                                <div class="history-date">
                                    <div class="date-badge">
                                        <div class="date-day">{{ booking.ngay_hen|date:'d' }}</div>
                                        <div class="date-month">Th{{ booking.ngay_hen|date:'m' }}</div>
                                        <div class="date-year">{{ booking.ngay_hen|date:'Y' }}</div>
                                    </div>
                                </div>

                                <div class="history-content">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="fw-bold mb-1">
                                                Lịch hẹn #{{ booking.ma_dat_lich }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="far fa-clock me-1"></i> {{ booking.gio_hen }}
                                            </small>
                                        </div>
                                        <span class="badge bg-success">Hoàn thành</span>
                                    </div>

                                    <!-- Stylist -->
                                    <div class="mb-2">
                                        <small class="text-muted">Thợ cắt:</small>
                                        <strong class="ms-1">
                                            {% if booking.nhan_vien %}
                                                {{ booking.nhan_vien.ho_ten }}
                                            {% else %}
                                                Thợ bất kỳ
                                            {% endif %}
                                        </strong>
                                    </div>

                                    <!-- Services -->
                                    <div class="mb-2">
                                        <small class="text-muted d-block mb-1">Dịch vụ:</small>
                                        {% for service in booking.dichvudatlich_set.all %}
                                        <span class="badge bg-light text-dark me-1">
                                            {{ service.dich_vu.ten }}
                                        </span>
                                        {% endfor %}
                                    </div>

                                    <!-- Price & Rating -->
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <strong class="text-success fs-5">{{ booking.tong_tien|floatformat:0 }}đ</strong>
                                        </div>
                                        <div>
                                            {% if booking.danhgia_set.exists %}
                                            {% with review=booking.danhgia_set.first %}
                                            <div class="rating-display">
                                                {% for i in "12345" %}
                                                <i class="fas fa-star {% if forloop.counter <= review.so_sao %}text-warning{% else %}text-muted{% endif %}"></i>
                                                {% endfor %}
                                            </div>
                                            {% endwith %}
                                            {% else %}
                                            <a href="{% url 'core:customer_review' booking.id %}" 
                                               class="btn btn-sm btn-outline-warning">
                                                <i class="far fa-star me-1"></i> Đánh giá
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="mt-3 border-top pt-3">
                                        <a href="{% url 'core:customer_booking_detail' booking.id %}" 
                                           class="btn btn-sm btn-outline-primary me-2">
                                            <i class="fas fa-eye me-1"></i> Xem chi tiết
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-success rebook-btn" 
                                                data-booking-id="{{ booking.id }}">
                                            <i class="fas fa-redo me-1"></i> Đặt lại
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Pagination -->
                        {% if is_paginated %}
                        <nav class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Trước</a>
                                </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                                {% endfor %}

                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Sau</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-history fa-4x text-muted mb-3"></i>
                            <h5 class="mb-3">Chưa có lịch sử sử dụng dịch vụ</h5>
                            <p class="text-muted mb-4">Đặt lịch ngay để bắt đầu trải nghiệm dịch vụ của chúng tôi</p>
                            <a href="{% url 'bookings:booking_step1' %}" class="btn btn-gold">
                                <i class="fas fa-plus-circle me-2"></i> Đặt lịch ngay
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.stat-card-simple {
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-card-simple h3 {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}

.history-timeline {
    position: relative;
}

.history-item {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid #e0e0e0;
}

.history-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.date-badge {
    background: linear-gradient(135deg, #d4af37, #8b7355);
    color: white;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    min-width: 80px;
}

.date-day {
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
}

.date-month, .date-year {
    font-size: 0.8rem;
    margin-top: 5px;
}

.history-content {
    flex: 1;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.rating-display i {
    font-size: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Rebook button
    $('.rebook-btn').click(function() {
        const bookingId = $(this).data('booking-id');
        
        if (confirm('Bạn muốn đặt lại với cùng dịch vụ và thợ này?')) {
            window.location.href = `/bookings/rebook/${bookingId}/`;
        }
    });
});
</script>
{% endblock %}
