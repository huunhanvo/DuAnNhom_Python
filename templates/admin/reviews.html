{% extends 'base.html' %}
{% load static %}

{% block title %}Quản lý đánh giá{% endblock %}

{% block extra_css %}
<style>
    .review-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .review-card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .customer-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .customer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .rating-stars {
        color: #ffc107;
        font-size: 1.2rem;
    }
    
    .star-empty {
        color: #dee2e6;
    }
    
    .review-content {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .review-images {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    
    .review-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .review-image:hover {
        transform: scale(1.1);
    }
    
    .review-reply {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .stats-overview {
        background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 25px;
    }
    
    .rating-breakdown {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        height: fit-content; /* Prevent height expansion */
        max-height: 300px; /* Add max height to prevent infinite growth */
        overflow: hidden; /* Hide any overflow content */
    }
    
    .rating-trend-chart {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        height: fit-content; /* Prevent height expansion */
        max-height: 300px; /* Add max height to prevent infinite growth */
        overflow: hidden; /* Hide any overflow content */
    }
    
    .rating-trend-chart canvas {
        max-height: 200px !important;
        max-width: 100% !important;
    }
    
    .rating-bar {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .rating-bar-label {
        width: 60px;
    }
    
    .rating-bar-fill {
        flex-grow: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        margin: 0 10px;
    }
    
    .rating-bar-value {
        height: 100%;
        background: #ffc107;
        /* transition: width 0.3s ease; */ /* Temporarily disabled to prevent height issues */
    }
    
    .rating-bar-count {
        width: 50px;
        text-align: right;
    }
    
    .filter-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
    }
    
    .filter-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 10px 20px;
        font-weight: 600;
    }
    
    .filter-tabs .nav-link.active {
        color: #8b4513;
        border-bottom-color: #8b4513;
        background: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-star"></i> Quản lý đánh giá</h2>
            <p class="text-muted mb-0">Quản lý & phản hồi đánh giá của khách hàng</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-success" onclick="exportReviews()">
                <i class="fas fa-file-excel"></i> Xuất danh sách
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="row align-items-center">
            <div class="col-md-3 text-center border-end">
                <h1 class="mb-0">{{ avg_rating|floatformat:1 }}/5</h1>
                <div class="rating-stars mt-2">
                    {% for i in "12345" %}
                    <i class="fas fa-star{% if forloop.counter > avg_rating|floatformat:0 %} star-empty{% endif %}"></i>
                    {% endfor %}
                </div>
                <p class="mb-0 mt-2">Đánh giá trung bình</p>
            </div>
            <div class="col-md-3 text-center border-end">
                <h2 class="mb-0">{{ total_reviews }}</h2>
                <p class="mb-0">Tổng đánh giá</p>
            </div>
            <div class="col-md-3 text-center border-end">
                <h2 class="mb-0">{{ pending_replies }}</h2>
                <p class="mb-0">Chờ phản hồi</p>
            </div>
            <div class="col-md-3 text-center">
                <h2 class="mb-0">{{ satisfaction_rate }}%</h2>
                <p class="mb-0">Tỷ lệ hài lòng</p>
            </div>
        </div>
    </div>

    <!-- Rating Breakdown -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="rating-breakdown">
                <h5 class="mb-4"><i class="fas fa-chart-bar"></i> Phân bố đánh giá</h5>
                {% for rating in rating_breakdown %}
                <div class="rating-bar">
                    <div class="rating-bar-label">
                        <i class="fas fa-star text-warning"></i> {{ rating.stars }}
                    </div>
                    <div class="rating-bar-fill">
                        <div class="rating-bar-value" style="width: {{ rating.percent }}%"></div>
                    </div>
                    <div class="rating-bar-count">{{ rating.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="rating-trend-chart">
                <h5 class="mb-4"><i class="fas fa-chart-line"></i> xu hướng đánh giá</h5>
                <canvas id="ratingTrendChart" width="400" height="200" style="max-height: 200px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <ul class="nav filter-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-filter="all">
                Tất cả ({{ total_reviews }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-filter="5">
                5 <i class="fas fa-star text-warning"></i> ({{ five_star_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-filter="4">
                4 <i class="fas fa-star text-warning"></i> ({{ four_star_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-filter="3">
                3 <i class="fas fa-star text-warning"></i> ({{ three_star_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-filter="2">
                2 <i class="fas fa-star text-warning"></i> ({{ two_star_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-filter="1">
                1 <i class="fas fa-star text-warning"></i> ({{ one_star_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-danger" href="#" data-filter="pending">
                <i class="fas fa-clock"></i> Chờ phản hồi ({{ pending_replies }})
            </a>
        </li>
    </ul>

    <!-- Search & Sort -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-5">
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Tìm kiếm theo tên, nội dung đánh giá...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortSelect">
                        <option value="-ngay_tao">Mới nhất</option>
                        <option value="ngay_tao">Cũ nhất</option>
                        <option value="-so_sao">Đánh giá cao</option>
                        <option value="so_sao">Đánh giá thấp</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="serviceFilter">
                        <option value="">Tất cả dịch vụ</option>
                        {% for service in services %}
                        <option value="{{ service.ten_dich_vu }}">{{ service.ten_dich_vu }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <span class="badge bg-secondary fs-6">Hiển thị: {{ total_reviews }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews List -->
    <div id="reviewsList">
        {% for review in reviews %}
        <div class="review-card" data-rating="{{ review.so_sao }}" data-replied="{% if review.phan_hoi %}true{% else %}false{% endif %}">
            <div class="review-header">
                <div class="customer-info">
                    <img src="{% if review.khach_hang.anh_dai_dien %}{{ MEDIA_URL }}{{ review.khach_hang.anh_dai_dien }}{% else %}/static/img/avatar-default.png{% endif %}" 
                         alt="{{ review.khach_hang.ho_ten }}" 
                         class="customer-avatar">
                    <div>
                        <h6 class="mb-1">{{ review.khach_hang.ho_ten }}</h6>
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> {{ review.ngay_tao|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                </div>
                
                <div class="text-end">
                    <div class="rating-stars">
                        {% for i in "12345" %}
                        <i class="fas fa-star{% if forloop.counter > review.so_sao %} star-empty{% endif %}"></i>
                        {% endfor %}
                    </div>
                    <small class="text-muted">Đơn hàng #{{ review.hoa_don.id }}</small>
                </div>
            </div>
            
            <div class="mb-3">
                <span class="badge bg-primary me-2">
                    <i class="fas fa-cut"></i> {{ review.dich_vu.ten_dich_vu }}
                </span>
                <span class="badge bg-info">
                    <i class="fas fa-user"></i> {{ review.nhan_vien.ho_ten }}
                </span>
            </div>
            
            <div class="review-content">
                <p class="mb-2">{{ review.noi_dung }}</p>
                
                {% if review.hinh_anh.all %}
                <div class="review-images">
                    {% for image in review.hinh_anh.all %}
                    <img src="{{ image.url }}" 
                         class="review-image" 
                         onclick="viewImage('{{ image.url }}')">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            {% if review.phan_hoi %}
            <div class="review-reply">
                <div class="d-flex align-items-start mb-2">
                    <i class="fas fa-reply text-primary me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <strong>Phản hồi từ quản lý</strong>
                        <small class="text-muted ms-2">{{ review.ngay_phan_hoi|date:"d/m/Y H:i" }}</small>
                    </div>
                </div>
                <p class="mb-0">{{ review.phan_hoi }}</p>
            </div>
            {% else %}
            <div class="alert alert-warning mb-0">
                <i class="fas fa-exclamation-triangle"></i> Chưa có phản hồi
            </div>
            {% endif %}
            
            <div class="d-flex gap-2 mt-3">
                {% if not review.phan_hoi %}
                <button class="btn btn-sm btn-primary" onclick="replyReview({{ review.id }})">
                    <i class="fas fa-reply"></i> Phản hồi
                </button>
                {% else %}
                <button class="btn btn-sm btn-outline-primary" onclick="editReply({{ review.id }})">
                    <i class="fas fa-edit"></i> Sửa phản hồi
                </button>
                {% endif %}
                <button class="btn btn-sm btn-outline-danger" onclick="deleteReview({{ review.id }})">
                    <i class="fas fa-trash"></i> Xóa
                </button>
                {% if review.so_sao >= 4 %}
                <button class="btn btn-sm btn-outline-success" onclick="shareReview({{ review.id }})">
                    <i class="fas fa-share"></i> Chia sẻ
                </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle"></i> Chưa có đánh giá nào
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if reviews.has_other_pages %}
    <nav aria-label="Phân trang" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if reviews.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ reviews.previous_page_number }}">Trước</a>
            </li>
            {% endif %}

            {% for num in reviews.paginator.page_range %}
            <li class="page-item {% if reviews.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if reviews.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ reviews.next_page_number }}">Sau</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply"></i> Phản hồi đánh giá
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reviewId">
                <div class="mb-3">
                    <label class="form-label">Nội dung phản hồi:</label>
                    <textarea class="form-control" id="replyContent" rows="5" 
                              placeholder="Cảm ơn bạn đã đánh giá..."></textarea>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Phản hồi chuyên nghiệp sẽ giúp cải thiện uy tín của cửa hàng
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitReply()">
                    <i class="fas fa-paper-plane"></i> Gửi phản hồi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="modalImage" src="" style="width: 100%; height: auto;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Rating Trend Chart
document.addEventListener('DOMContentLoaded', function() {
    const trendCtx = document.getElementById('ratingTrendChart');
    if (trendCtx && !trendCtx.chartInitialized) {
        try {
            // Mark as initialized to prevent multiple initializations
            trendCtx.chartInitialized = true;
            
            // Debug: Log dữ liệu biểu đồ
            console.log('Trend Labels:', {{ trend_labels|safe }});
            console.log('Trend Data:', {{ trend_data|safe }});
            
            const trendChart = new Chart(trendCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: {{ trend_labels|safe }},
                    datasets: [{
                        label: 'Đánh giá trung bình',
                        data: {{ trend_data|safe }},
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ffc107',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: 'Số lượng đánh giá',
                        data: {{ trend_counts|safe }},
                        type: 'bar',
                        backgroundColor: 'rgba(54, 162, 235, 0.3)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#ffc107',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    return 'Ngày ' + context[0].label;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return 'Điểm TB: ' + context.parsed.y.toFixed(1) + ' ⭐';
                                    } else {
                                        return 'Số đánh giá: ' + context.parsed.y;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + ' ⭐';
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Điểm đánh giá',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Số lượng',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        },
                        point: {
                            hoverBorderWidth: 3
                        }
                    },
                    animation: {
                        duration: 0, /* Disable animation to prevent layout issues */
                        easing: 'easeInOutQuart'
                    }
                }
            });
        } catch (error) {
            console.error('Lỗi khởi tạo biểu đồ:', error);
            document.getElementById('ratingTrendChart').parentElement.innerHTML = 
                '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Không thể tải biểu đồ xu hướng. Vui lòng thử lại sau.</div>';
        }
    } else {
        console.error('Không tìm thấy canvas element ratingTrendChart');
    }
});

$(document).ready(function() {
    let currentFilters = {
        rating: 'all',
        service: '',
        search: '',
        sort: '-ngay_tao'
    };
    
    // Filter tabs
    $('.filter-tabs .nav-link').click(function(e) {
        e.preventDefault();
        $('.filter-tabs .nav-link').removeClass('active');
        $(this).addClass('active');
        
        currentFilters.rating = $(this).data('filter');
        applyAllFilters();
    });
    
    // Search
    $('#searchInput').on('input', debounce(function() {
        currentFilters.search = $(this).val().toLowerCase();
        applyAllFilters();
    }, 300));
    
    // Service filter
    $('#serviceFilter').change(function() {
        currentFilters.service = $(this).val();
        applyAllFilters();
    });
    
    // Sort
    $('#sortSelect').change(function() {
        currentFilters.sort = $(this).val();
        applySorting();
    });
    
    function applyAllFilters() {
        $('.review-card').each(function() {
            const $card = $(this);
            let show = true;
            
            // Rating filter
            if (currentFilters.rating !== 'all') {
                if (currentFilters.rating === 'pending') {
                    show = show && ($card.data('replied') === 'false' || $card.data('replied') === false);
                } else {
                    show = show && $card.data('rating') == currentFilters.rating;
                }
            }
            
            // Service filter
            if (currentFilters.service) {
                const serviceText = $card.find('.badge').first().text();
                show = show && serviceText.includes(currentFilters.service);
            }
            
            // Search filter
            if (currentFilters.search) {
                const text = $card.text().toLowerCase();
                show = show && text.includes(currentFilters.search);
            }
            
            $card.toggle(show);
        });
        
        updateFilterCounts();
    }
    
    function applySorting() {
        const $container = $('#reviewsList');
        const $cards = $container.children('.review-card').detach();
        
        $cards.sort(function(a, b) {
            const $a = $(a);
            const $b = $(b);
            
            switch (currentFilters.sort) {
                case '-so_sao':
                    return $b.data('rating') - $a.data('rating');
                case 'so_sao':
                    return $a.data('rating') - $b.data('rating');
                case 'ngay_tao':
                    // Simple string comparison for date sorting (works for dd/mm/yyyy format)
                    const aDate = $a.find('small').text();
                    const bDate = $b.find('small').text();
                    return aDate.localeCompare(bDate);
                default: // -ngay_tao
                    const aDateDesc = $a.find('small').text();
                    const bDateDesc = $b.find('small').text();
                    return bDateDesc.localeCompare(aDateDesc);
            }
        });
        
        $container.append($cards);
    }
    
    function updateFilterCounts() {
        const visibleCount = $('.review-card:visible').length;
        $('.badge.bg-secondary').text(`Hiển thị: ${visibleCount}`);
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
});

// Expose functions to global scope for onclick handlers
window.filterReviews = function(filter) {
    // This function is now handled by applyAllFilters in document ready
    // Kept for compatibility
    $('.filter-tabs .nav-link').removeClass('active');
    $(`.filter-tabs .nav-link[data-filter="${filter}"]`).addClass('active');
    
    if (filter === 'all') {
        $('.review-card').show();
    } else if (filter === 'pending') {
        $('.review-card').hide();
        $('.review-card[data-replied="false"]').show();
    } else {
        $('.review-card').hide();
        $(`.review-card[data-rating="${filter}"]`).show();
    }
}

window.replyReview = function(reviewId) {
    $('#reviewId').val(reviewId);
    $('#replyContent').val('');
    $('.modal-title').html('<i class="fas fa-reply"></i> Phản hồi đánh giá');
    $('#replyModal').modal('show');
}

window.editReply = function(reviewId) {
    $.ajax({
        url: `/api/reviews/${reviewId}/`,
        method: 'GET',
        success: function(review) {
            $('#reviewId').val(reviewId);
            $('#replyContent').val(review.phan_hoi);
            $('.modal-title').html('<i class="fas fa-edit"></i> Chỉnh sửa phản hồi');
            $('#replyModal').modal('show');
        },
        error: function(xhr) {
            alert('Không thể tải thông tin đánh giá: ' + (xhr.responseJSON?.message || 'Lỗi không xác định'));
        }
    });
}

window.submitReply = function() {
    const reviewId = $('#reviewId').val();
    const content = $('#replyContent').val();
    
    if (!content) {
        alert('Vui lòng nhập nội dung phản hồi');
        return;
    }
    
    $.ajax({
        url: `/api/reviews/${reviewId}/reply/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: { phan_hoi: content },
        success: function(response) {
            if (response.success) {
                alert(response.message);
                $('#replyModal').modal('hide');
                location.reload();
            } else {
                alert('Có lỗi: ' + response.message);
            }
        },
        error: function(xhr) {
            alert('Có lỗi xảy ra: ' + (xhr.responseJSON?.message || 'Lỗi không xác định'));
        }
    });
}

window.deleteReview = function(reviewId) {
    if (confirm('Bạn có chắc muốn xóa đánh giá này?')) {
        $.ajax({
            url: `/api/reviews/${reviewId}/delete/`,
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Có lỗi: ' + response.message);
                }
            },
            error: function(xhr) {
                alert('Có lỗi xảy ra: ' + (xhr.responseJSON?.message || 'Lỗi không xác định'));
            }
        });
    }
}

window.shareReview = function(reviewId) {
    $.ajax({
        url: `/api/reviews/${reviewId}/`,
        method: 'GET',
        success: function(review) {
            const shareText = `⭐ Đánh giá ${review.so_sao}/5 sao từ khách hàng!\n\n"${review.noi_dung}"\n\n- ${review.khach_hang} về dịch vụ ${review.dich_vu}`;
            
            // Tạo modal chia sẻ
            const shareModal = `
                <div class="modal fade" id="shareModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-share"></i> Chia sẻ đánh giá tích cực
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Nội dung chia sẻ:</label>
                                    <textarea class="form-control" id="shareContent" rows="4" readonly>${shareText}</textarea>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="copyToClipboard()">
                                        <i class="fas fa-copy"></i> Sao chép văn bản
                                    </button>
                                    <button class="btn btn-success" onclick="shareOnFacebook(${reviewId})">
                                        <i class="fab fa-facebook"></i> Chia sẻ Facebook
                                    </button>
                                    <button class="btn btn-info" onclick="shareOnZalo()">
                                        <i class="fas fa-comment"></i> Chia sẻ Zalo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#shareModal').remove();
            $('body').append(shareModal);
            $('#shareModal').modal('show');
        },
        error: function() {
            alert('Không thể tải thông tin đánh giá để chia sẻ');
        }
    });
}

window.copyToClipboard = function() {
    const shareContent = document.getElementById('shareContent');
    shareContent.select();
    document.execCommand('copy');
    alert('Đã sao chép nội dung!');
}

window.shareOnFacebook = function(reviewId) {
    const url = encodeURIComponent(window.location.origin + '/reviews/' + reviewId);
    const text = encodeURIComponent(document.getElementById('shareContent').value);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
}

window.shareOnZalo = function() {
    const text = encodeURIComponent(document.getElementById('shareContent').value);
    alert('Vui lòng sao chép nội dung và chia sẻ trên Zalo thủ công.');
}

window.viewImage = function(url) {
    $('#modalImage').attr('src', url);
    $('#imageModal').modal('show');
}

window.exportReviews = function() {
    window.location.href = '/admin/reviews/export/';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
