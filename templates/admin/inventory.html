{% extends 'base.html' %}
{% load static %}

{% block title %}Quản lý kho hàng{% endblock %}

{% block extra_css %}
<style>
    .inventory-card {
        border-radius: 15px;
        transition: all 0.3s ease;
        border: 2px solid #dee2e6;
    }
    
    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(139, 69, 19, 0.2);
        border-color: #8b4513;
    }
    
    .stock-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .stock-low { background: #fff3cd; color: #856404; }
    .stock-out { background: #f8d7da; color: #721c24; }
    .stock-ok { background: #d4edda; color: #155724; }
    
    .product-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 10px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .category-chip {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 5px;
    }
    
    .cat-tools { background: #e3f2fd; color: #1976d2; }
    .cat-products { background: #f3e5f5; color: #7b1fa2; }
    .cat-supplies { background: #fff3e0; color: #f57c00; }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
    }
    
    .quantity-controls button {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: 2px solid #8b4513;
        background: white;
        color: #8b4513;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .quantity-controls button:hover {
        background: #8b4513;
        color: white;
    }
    
    .stock-progress {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .stock-progress-bar {
        height: 100%;
        transition: width 0.3s;
    }
    
    .transaction-history {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .transaction-item {
        padding: 12px;
        border-left: 4px solid #dee2e6;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .transaction-item.import { border-left-color: #28a745; }
    .transaction-item.export { border-left-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-boxes"></i> Quản lý kho hàng</h2>
            <p class="text-muted mb-0">Quản lý sản phẩm, công cụ & vật tư tiêu hao</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-outline-success" onclick="importStock()">
                <i class="fas fa-file-import"></i> Nhập kho
            </button>
            <button class="btn btn-outline-warning" onclick="exportStock()">
                <i class="fas fa-file-export"></i> Xuất kho
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                <i class="fas fa-plus"></i> Thêm sản phẩm
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card inventory-card text-center">
                <div class="card-body">
                    <i class="fas fa-box-open fa-2x text-primary mb-2"></i>
                    <h3 class="mb-0">{{ total_items }}</h3>
                    <small class="text-muted">Tổng sản phẩm</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card inventory-card text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <h3 class="mb-0 text-warning">{{ low_stock_items }}</h3>
                    <small class="text-muted">Sắp hết hàng</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card inventory-card text-center">
                <div class="card-body">
                    <i class="fas fa-ban fa-2x text-danger mb-2"></i>
                    <h3 class="mb-0 text-danger">{{ out_of_stock }}</h3>
                    <small class="text-muted">Hết hàng</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card inventory-card text-center">
                <div class="card-body">
                    <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                    <h3 class="mb-0 text-success">{{ total_value|floatformat:0 }}đ</h3>
                    <small class="text-muted">Giá trị kho</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter & Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Tìm kiếm sản phẩm...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="categoryFilter">
                        <option value="all">Tất cả danh mục</option>
                        <option value="tools">Công cụ</option>
                        <option value="products">Sản phẩm</option>
                        <option value="supplies">Vật tư</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="stockFilter">
                        <option value="all">Tất cả trạng thái</option>
                        <option value="ok">Còn hàng</option>
                        <option value="low">Sắp hết</option>
                        <option value="out">Hết hàng</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortSelect">
                        <option value="name">Tên A-Z</option>
                        <option value="-name">Tên Z-A</option>
                        <option value="quantity">Số lượng tăng</option>
                        <option value="-quantity">Số lượng giảm</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="toggleView()">
                        <i class="fas fa-th"></i> <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Grid -->
    <div class="row" id="inventoryGrid">
        {% for item in inventory_items %}
        <div class="col-md-4 mb-4">
            <div class="card inventory-card">
                <div class="card-body position-relative">
                    {% if item.stock_status == 'out' %}
                    <span class="stock-badge stock-out">Hết hàng</span>
                    {% elif item.stock_status == 'low' %}
                    <span class="stock-badge stock-low">Sắp hết</span>
                    {% else %}
                    <span class="stock-badge stock-ok">Còn hàng</span>
                    {% endif %}
                    
                    <img src="{{ item.image|default:'/static/img/product-default.jpg' }}" 
                         alt="{{ item.name }}" 
                         class="product-image mb-3">
                    
                    <span class="category-chip cat-{{ item.category }}">
                        {{ item.get_category_display }}
                    </span>
                    
                    <h5 class="mt-2 mb-1">{{ item.name }}</h5>
                    <p class="text-muted small mb-2">{{ item.description|truncatewords:10 }}</p>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><strong>Đơn giá:</strong> {{ item.unit_price|floatformat:0 }}đ</span>
                        <span><strong>ĐVT:</strong> {{ item.unit }}</span>
                    </div>
                    
                    <div class="stock-progress">
                        <div class="stock-progress-bar bg-{{ item.stock_color }}" 
                             style="width: {{ item.stock_percentage }}%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0 text-{{ item.stock_color }}">{{ item.quantity }}</h4>
                            <small class="text-muted">Tồn kho / {{ item.min_quantity }} min</small>
                        </div>
                        <div class="quantity-controls">
                            <button onclick="adjustStock({{ item.id }}, -1)" title="Giảm">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="adjustStock({{ item.id }}, 1)" title="Tăng">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary flex-fill" 
                                onclick="viewHistory({{ item.id }})">
                            <i class="fas fa-history"></i> Lịch sử
                        </button>
                        <button class="btn btn-sm btn-outline-success" 
                                onclick="editItem({{ item.id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteItem({{ item.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> Chưa có sản phẩm nào trong kho
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Thêm sản phẩm mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên sản phẩm: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Danh mục: <span class="text-danger">*</span></label>
                            <select class="form-select" id="itemCategory" required>
                                <option value="">-- Chọn --</option>
                                <option value="tools">Công cụ (kéo, tông đơ)</option>
                                <option value="products">Sản phẩm (dầu gội, sáp)</option>
                                <option value="supplies">Vật tư (khăn, găng tay)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Số lượng hiện tại:</label>
                            <input type="number" class="form-control" id="itemQuantity" 
                                   min="0" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Số lượng tối thiểu:</label>
                            <input type="number" class="form-control" id="itemMinQuantity" 
                                   min="0" value="10">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Đơn vị tính:</label>
                            <input type="text" class="form-control" id="itemUnit" 
                                   placeholder="Cái, Lọ, Hộp..." value="Cái">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Đơn giá (VNĐ):</label>
                            <input type="number" class="form-control" id="itemPrice" 
                                   min="0" step="1000" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nhà cung cấp:</label>
                            <input type="text" class="form-control" id="itemSupplier">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Mô tả:</label>
                            <textarea class="form-control" id="itemDescription" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stock History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history"></i> Lịch sử xuất nhập kho
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="transaction-history" id="transactionHistory">
                    <!-- Dynamically loaded -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Search functionality
    $('#searchInput').on('input', function() {
        const search = $(this).val().toLowerCase();
        $('.card.inventory-card').parent().each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(search));
        });
    });
});

function adjustStock(itemId, delta) {
    if (confirm(`${delta > 0 ? 'Tăng' : 'Giảm'} số lượng?`)) {
        $.ajax({
            url: `/api/inventory/${itemId}/adjust/`,
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            data: JSON.stringify({ delta: delta }),
            contentType: 'application/json',
            success: function() {
                location.reload();
            }
        });
    }
}

function viewHistory(itemId) {
    $.ajax({
        url: `/api/inventory/${itemId}/history/`,
        method: 'GET',
        success: function(data) {
            let html = '';
            data.forEach(function(item) {
                html += `
                    <div class="transaction-item ${item.type}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${item.type === 'import' ? 'NHẬP' : 'XUẤT'} KHO</strong>
                                <p class="mb-0 small">${item.note}</p>
                            </div>
                            <div class="text-end">
                                <h5 class="mb-0 text-${item.type === 'import' ? 'success' : 'danger'}">
                                    ${item.type === 'import' ? '+' : '-'}${item.quantity}
                                </h5>
                                <small class="text-muted">${item.date}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#transactionHistory').html(html);
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }
    });
}

function editItem(itemId) {
    // Load item data and show modal
    alert('Chức năng sửa sản phẩm - Cần API backend');
}

function deleteItem(itemId) {
    if (confirm('Xóa sản phẩm này?')) {
        alert('Chức năng xóa - Cần API backend');
    }
}

function saveItem() {
    alert('Chức năng lưu - Cần API backend');
}

function importStock() {
    alert('Chức năng nhập kho - Cần API backend');
}

function exportStock() {
    alert('Chức năng xuất kho - Cần API backend');
}

function toggleView() {
    alert('Chuyển đổi grid/list view - Cần implement');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
