{% extends 'base.html' %}
{% load static %}

{% block title %}Quản lý khuyến mãi{% endblock %}

{% block extra_css %}
<style>
    .promotion-card {
        border: 2px solid #dee2e6;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }
    
    .promotion-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(139, 69, 19, 0.2);
        border-color: #8b4513;
    }
    
    .promotion-header {
        background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%);
        color: white;
        padding: 20px;
        position: relative;
    }
    
    .promotion-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .discount-amount {
        font-size: 3rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .voucher-code {
        display: inline-block;
        background: white;
        color: #8b4513;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.2rem;
        border: 2px dashed #8b4513;
        cursor: pointer;
    }
    
    .voucher-code:hover {
        background: #f8f9fa;
    }
    
    .promotion-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
    }
    
    .stat-box {
        text-align: center;
    }
    
    .filter-chips {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    
    .filter-chip {
        padding: 8px 20px;
        border-radius: 20px;
        border: 2px solid #dee2e6;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-chip.active {
        background: #8b4513;
        color: white;
        border-color: #8b4513;
    }
    
    .filter-chip:hover {
        border-color: #8b4513;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-tags"></i> Quản lý khuyến mãi</h2>
            <p class="text-muted mb-0">Quản lý voucher & chương trình khuyến mãi</p>
        </div>
        <div class="col-md-6 text-end">
            <a href="{% url 'admin_promotions_export' %}" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Xuất danh sách
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#promotionModal">
                <i class="fas fa-plus"></i> Tạo khuyến mãi
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ total_promotions }}</h3>
                    <small class="text-muted">Tổng CTKM</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success mb-0">{{ active_promotions }}</h3>
                    <small class="text-muted">Đang hoạt động</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning mb-0">{{ total_usage }}</h3>
                    <small class="text-muted">Lượt sử dụng</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger mb-0">{{ expired_promotions }}</h3>
                    <small class="text-muted">Đã hết hạn</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Stats Row -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info mb-0">{{ upcoming_promotions }}</h3>
                    <small class="text-muted">Sắp diễn ra</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-secondary mb-0">{{ filtered_count }}</h3>
                    <small class="text-muted">Kết quả hiển thị</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger mb-0">{{ total_discount|floatformat:0 }}đ</h3>
                    <small class="text-muted">Tổng giảm giá</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Server-side Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Trạng thái:</label>
                    <select class="form-select" name="status" onchange="document.getElementById('filterForm').submit()">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Loại giảm giá:</label>
                    <select class="form-select" name="type" onchange="document.getElementById('filterForm').submit()">
                        {% for value, label in type_choices %}
                        <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tìm kiếm:</label>
                    <input type="text" class="form-control" name="search" value="{{ search }}" 
                           placeholder="Mã voucher, tên, mô tả...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Lọc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Quick Filter Chips -->
    <div class="filter-chips mb-4">
        <a href="?status=all" class="filter-chip {% if status_filter == 'all' %}active{% endif %}">
            <i class="fas fa-th"></i> Tất cả
        </a>
        <a href="?status=active" class="filter-chip {% if status_filter == 'active' %}active{% endif %}">
            <i class="fas fa-check-circle text-success"></i> Đang hoạt động
        </a>
        <a href="?status=upcoming" class="filter-chip {% if status_filter == 'upcoming' %}active{% endif %}">
            <i class="fas fa-clock text-info"></i> Sắp diễn ra
        </a>
        <a href="?status=expired" class="filter-chip {% if status_filter == 'expired' %}active{% endif %}">
            <i class="fas fa-times-circle text-danger"></i> Đã hết hạn
        </a>
        <a href="?type=phan_tram" class="filter-chip {% if type_filter == 'phan_tram' %}active{% endif %}">
            <i class="fas fa-percent text-warning"></i> Giảm %
        </a>
        <a href="?type=tien_mat" class="filter-chip {% if type_filter == 'tien_mat' %}active{% endif %}">
            <i class="fas fa-dollar-sign text-primary"></i> Giảm tiền
        </a>
    </div>

    <!-- Promotions Grid -->
    <div class="row">
        {% for promo in promotions %}
        <div class="col-md-6 col-lg-4">
            <div class="promotion-card" data-status="{{ promo.status }}" data-type="{{ promo.loai_giam_gia }}">
                <div class="promotion-header">
                    {% if promo.status == 'active' %}
                    <span class="promotion-badge bg-success">Đang hoạt động</span>
                    {% elif promo.status == 'upcoming' %}
                    <span class="promotion-badge bg-warning">Sắp diễn ra</span>
                    {% else %}
                    <span class="promotion-badge bg-secondary">Hết hạn</span>
                    {% endif %}
                    
                    <div class="text-center mb-3">
                        {% if promo.loai_giam_gia == 'percentage' %}
                        <div class="discount-amount">{{ promo.gia_tri_giam }}%</div>
                        <p class="mb-0">Giảm giá</p>
                        {% else %}
                        <div class="discount-amount">{{ promo.gia_tri_giam|floatformat:0 }}đ</div>
                        <p class="mb-0">Giảm trực tiếp</p>
                        {% endif %}
                    </div>
                    
                    <div class="text-center">
                        <div class="voucher-code" onclick="copyCode('{{ promo.ma_voucher }}')">
                            <i class="fas fa-ticket-alt"></i> {{ promo.ma_voucher }}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <h5 class="mb-3">{{ promo.ten_chuong_trinh }}</h5>
                    <p class="text-muted small">{{ promo.mo_ta }}</p>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> 
                            {{ promo.ngay_bat_dau|date:"d/m/Y" }} - {{ promo.ngay_ket_thuc|date:"d/m/Y" }}
                        </small>
                    </div>
                    
                    {% if promo.gia_tri_don_toi_thieu > 0 %}
                    <div class="alert alert-info py-2 px-3 mb-3">
                        <small>
                            <i class="fas fa-info-circle"></i> 
                            Đơn tối thiểu: {{ promo.gia_tri_don_toi_thieu|floatformat:0 }}đ
                        </small>
                    </div>
                    {% endif %}
                    
                    {% if promo.giam_toi_da > 0 %}
                    <div class="alert alert-warning py-2 px-3 mb-3">
                        <small>
                            <i class="fas fa-exclamation-triangle"></i> 
                            Giảm tối đa: {{ promo.giam_toi_da|floatformat:0 }}đ
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="promotion-stats">
                        <div class="stat-box">
                            <h6 class="text-primary mb-0">{{ promo.so_luong_con_lai }}</h6>
                            <small class="text-muted">Còn lại</small>
                        </div>
                        <div class="stat-box">
                            <h6 class="text-success mb-0">{{ promo.da_su_dung }}</h6>
                            <small class="text-muted">Đã dùng</small>
                        </div>
                        <div class="stat-box">
                            <h6 class="text-warning mb-0">{{ promo.tong_so_luong }}</h6>
                            <small class="text-muted">Tổng số</small>
                        </div>
                    </div>
                    
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-success" 
                             style="width: {{ promo.usage_percentage }}%"></div>
                    </div>
                    <small class="text-muted">{{ promo.usage_percentage|floatformat:1 }}% đã sử dụng</small>
                    
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-outline-primary flex-fill" 
                                onclick="editPromotion({
                                    id: {{ promo.id }},
                                    ma_voucher: '{{ promo.ma_voucher }}',
                                    ten_voucher: '{{ promo.ten_voucher }}',
                                    mo_ta: '{{ promo.mo_ta|default:"" }}',
                                    loai_giam: '{{ promo.loai_giam }}',
                                    gia_tri_giam: {{ promo.gia_tri_giam }},
                                    gia_tri_don_hang_toi_thieu: {{ promo.gia_tri_don_hang_toi_thieu|default:"0" }},
                                    gia_tri_giam_toi_da: {{ promo.gia_tri_giam_toi_da|default:"0" }},
                                    ngay_bat_dau: '{{ promo.ngay_bat_dau|date:"Y-m-d" }}T{{ promo.ngay_bat_dau|time:"H:i" }}',
                                    ngay_ket_thuc: '{{ promo.ngay_ket_thuc|date:"Y-m-d" }}T{{ promo.ngay_ket_thuc|time:"H:i" }}',
                                    so_luong_toi_da: {{ promo.so_luong_toi_da|default:"0" }},
                                    trang_thai: '{{ promo.trang_thai }}'
                                })">
                            <i class="fas fa-edit"></i> Sửa
                        </button>
                        <button class="btn btn-sm btn-outline-success" 
                                onclick="viewStats({{ promo.id }})">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deletePromotion({{ promo.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> Chưa có chương trình khuyến mãi nào
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create/Edit Promotion Modal -->
<div class="modal fade" id="createPromotionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Tạo chương trình khuyến mãi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="promotionForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên chương trình: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="promoName" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Mã voucher: <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="voucherCode" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="generateCode()">
                                    <i class="fas fa-random"></i> Tạo mã
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Mô tả:</label>
                            <textarea class="form-control" id="promoDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Loại giảm giá: <span class="text-danger">*</span></label>
                            <select class="form-select" id="discountType" required>
                                <option value="percentage">Giảm theo %</option>
                                <option value="fixed">Giảm số tiền cố định</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Giá trị giảm: <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="discountValue" required>
                        </div>
                        
                        <div class="col-md-4" id="maxDiscountDiv">
                            <label class="form-label">Giảm tối đa (VNĐ):</label>
                            <input type="number" class="form-control" id="maxDiscount" value="0">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Ngày bắt đầu: <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="startDate" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Ngày kết thúc: <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="endDate" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Tổng số lượng: <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="totalQuantity" min="1" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Giới hạn/khách:</label>
                            <input type="number" class="form-control" id="limitPerCustomer" value="1">
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Đơn hàng tối thiểu (VNĐ):</label>
                            <input type="number" class="form-control" id="minOrderValue" value="0">
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Áp dụng cho:</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="applyAllCustomers" checked>
                                        <label class="form-check-label" for="applyAllCustomers">
                                            Tất cả khách hàng
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="applyNewCustomers">
                                        <label class="form-check-label" for="applyNewCustomers">
                                            Khách hàng mới
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="applyVIP">
                                        <label class="form-check-label" for="applyVIP">
                                            Khách VIP
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Dịch vụ áp dụng:</label>
                            <select class="form-select" id="applyServices" multiple size="6">
                                <option value="all" selected>Tất cả dịch vụ</option>
                                {% for service in services %}
                                <option value="{{ service.id }}">{{ service.ten_dich_vu }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="savePromotion()">
                    <i class="fas fa-save"></i> Lưu chương trình
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Filter chips
    $('.filter-chip').click(function() {
        $('.filter-chip').removeClass('active');
        $(this).addClass('active');
        
        const filter = $(this).data('filter');
        filterPromotions(filter);
    });
    
    // Discount type change
    $('#discountType').change(function() {
        if ($(this).val() === 'percentage') {
            $('#maxDiscountDiv').show();
        } else {
            $('#maxDiscountDiv').hide();
        }
    });
});

function filterPromotions(filter) {
    if (filter === 'all') {
        $('.promotion-card').parent().show();
    } else {
        $('.promotion-card').parent().hide();
        $(`.promotion-card[data-status="${filter}"], .promotion-card[data-type="${filter}"]`).parent().show();
    }
}

function copyCode(code) {
    navigator.clipboard.writeText(code);
    alert('Đã copy mã: ' + code);
}

function generateCode() {
    const code = 'VC' + Math.random().toString(36).substring(2, 8).toUpperCase();
    $('#voucherCode').val(code);
}

function editPromotion(id) {
    // Load and edit promotion
}

function viewStats(id) {
    // View promotion statistics
}

function deletePromotion(id) {
    if (confirm('Bạn có chắc muốn xóa chương trình khuyến mãi này? Hành động này không thể hoàn tác!')) {
        // Send DELETE request
        fetch(`/admin/promotions/delete/${id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and reload page
                alert(data.message);
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi xóa voucher!');
        });
    }
}

function savePromotion() {
    // Save promotion
}

function exportVouchers() {
    window.location.href = '/admin/promotions/export/';
}
</script>

<!-- Promotion Modal -->
<div class="modal fade" id="promotionModal" tabindex="-1" aria-labelledby="promotionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promotionModalLabel">
                    <i class="fas fa-plus"></i> Tạo khuyến mãi mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="promotionForm" method="POST" action="{% url 'admin_promotions' %}">
                {% csrf_token %}
                <input type="hidden" id="promotionId" name="voucher_id" value="">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ma_voucher" class="form-label">Mã voucher *</label>
                            <input type="text" class="form-control" id="ma_voucher" name="ma_voucher" required 
                                   placeholder="Ví dụ: SALE20">
                        </div>
                        <div class="col-md-6">
                            <label for="ten_voucher" class="form-label">Tên voucher *</label>
                            <input type="text" class="form-control" id="ten_voucher" name="ten_voucher" required 
                                   placeholder="Ví dụ: Giảm giá 20%">
                        </div>
                        <div class="col-12">
                            <label for="mo_ta" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="mo_ta" name="mo_ta" rows="3" 
                                      placeholder="Mô tả chi tiết về chương trình khuyến mãi"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="loai_giam" class="form-label">Loại giảm giá *</label>
                            <select class="form-select" id="loai_giam" name="loai_giam" required onchange="toggleDiscountValue()">
                                <option value="">-- Chọn loại --</option>
                                <option value="phan_tram">Giảm theo phần trăm (%)</option>
                                <option value="tien_mat">Giảm tiền mặt (VNĐ)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="gia_tri_giam" class="form-label">Giá trị giảm *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="gia_tri_giam" name="gia_tri_giam" 
                                       required min="0" step="0.01">
                                <span class="input-group-text" id="discount-unit">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="gia_tri_don_hang_toi_thieu" class="form-label">Giá trị đơn hàng tối thiểu</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="gia_tri_don_hang_toi_thieu" 
                                       name="gia_tri_don_hang_toi_thieu" min="0" step="1000" placeholder="0">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="gia_tri_giam_toi_da" class="form-label">Giá trị giảm tối đa</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="gia_tri_giam_toi_da" 
                                       name="gia_tri_giam_toi_da" min="0" step="1000" placeholder="Không giới hạn">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="ngay_bat_dau" class="form-label">Ngày bắt đầu *</label>
                            <input type="datetime-local" class="form-control" id="ngay_bat_dau" name="ngay_bat_dau" required>
                        </div>
                        <div class="col-md-6">
                            <label for="ngay_ket_thuc" class="form-label">Ngày kết thúc *</label>
                            <input type="datetime-local" class="form-control" id="ngay_ket_thuc" name="ngay_ket_thuc" required>
                        </div>
                        <div class="col-md-6">
                            <label for="so_luong_toi_da" class="form-label">Số lượng tối đa</label>
                            <input type="number" class="form-control" id="so_luong_toi_da" name="so_luong_toi_da" 
                                   min="1" placeholder="Không giới hạn">
                        </div>
                        <div class="col-md-6">
                            <label for="trang_thai" class="form-label">Trạng thái *</label>
                            <select class="form-select" id="trang_thai" name="trang_thai" required>
                                <option value="active">Hoạt động</option>
                                <option value="inactive">Tạm dừng</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> <span id="submitButtonText">Tạo voucher</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleDiscountValue() {
    const loaiGiam = document.getElementById('loai_giam').value;
    const discountUnit = document.getElementById('discount-unit');
    const giaTriGiam = document.getElementById('gia_tri_giam');
    
    if (loaiGiam === 'phan_tram') {
        discountUnit.textContent = '%';
        giaTriGiam.max = '100';
        giaTriGiam.placeholder = 'Ví dụ: 20';
    } else if (loaiGiam === 'tien_mat') {
        discountUnit.textContent = 'VNĐ';
        giaTriGiam.removeAttribute('max');
        giaTriGiam.placeholder = 'Ví dụ: 50000';
    }
}

function editPromotion(voucher) {
    // Populate form for editing
    document.getElementById('promotionModalLabel').innerHTML = '<i class="fas fa-edit"></i> Chỉnh sửa khuyến mãi';
    document.getElementById('submitButtonText').textContent = 'Cập nhật voucher';
    document.getElementById('promotionId').value = voucher.id;
    document.getElementById('ma_voucher').value = voucher.ma_voucher;
    document.getElementById('ten_voucher').value = voucher.ten_voucher;
    document.getElementById('mo_ta').value = voucher.mo_ta || '';
    document.getElementById('loai_giam').value = voucher.loai_giam;
    document.getElementById('gia_tri_giam').value = voucher.gia_tri_giam;
    document.getElementById('gia_tri_don_hang_toi_thieu').value = voucher.gia_tri_don_hang_toi_thieu || '';
    document.getElementById('gia_tri_giam_toi_da').value = voucher.gia_tri_giam_toi_da || '';
    document.getElementById('ngay_bat_dau').value = voucher.ngay_bat_dau;
    document.getElementById('ngay_ket_thuc').value = voucher.ngay_ket_thuc;
    document.getElementById('so_luong_toi_da').value = voucher.so_luong_toi_da || '';
    document.getElementById('trang_thai').value = voucher.trang_thai;
    
    toggleDiscountValue();
    
    // Show modal
    new bootstrap.Modal(document.getElementById('promotionModal')).show();
}

// Reset form when modal is hidden
document.getElementById('promotionModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('promotionForm').reset();
    document.getElementById('promotionModalLabel').innerHTML = '<i class="fas fa-plus"></i> Tạo khuyến mãi mới';
    document.getElementById('submitButtonText').textContent = 'Tạo voucher';
    document.getElementById('promotionId').value = '';
});
</script>
{% endblock %}
