{% extends 'base.html' %}
{% load static %}

{% block title %}Lịch làm việc của tôi{% endblock %}

{% block extra_css %}
<style>
    .schedule-header {
        background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .current-shift-card {
        background: white;
        border: 3px solid #28a745;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
    }
    
    .calendar-view {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-top: 20px;
    }
    
    .calendar-day {
        aspect-ratio: 1;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .calendar-day:hover {
        border-color: #8b4513;
        box-shadow: 0 2px 10px rgba(139, 69, 19, 0.2);
    }
    
    .calendar-day.today {
        background: #fff3cd;
        border-color: #ffc107;
        font-weight: bold;
    }
    
    .calendar-day.has-shift {
        background: #d4edda;
        border-color: #28a745;
    }
    
    .calendar-day.off-day {
        background: #f8f9fa;
        color: #6c757d;
    }
    
    .day-number {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .shift-indicator {
        font-size: 0.75rem;
        padding: 3px 6px;
        border-radius: 5px;
        margin: 2px 0;
        display: block;
    }
    
    .shift-morning {
        background: #ffc107;
        color: #856404;
    }
    
    .shift-afternoon {
        background: #17a2b8;
        color: white;
    }
    
    .shift-evening {
        background: #6c757d;
        color: white;
    }
    
    .shift-fullday {
        background: #28a745;
        color: white;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .stat-box {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .leave-request-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #ffc107;
    }
    
    .timeline-view {
        background: white;
        border-radius: 15px;
        padding: 20px;
    }
    
    .timeline-item {
        display: flex;
        gap: 20px;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .timeline-time {
        width: 100px;
        font-weight: bold;
        color: #8b4513;
    }
    
    .timeline-content {
        flex-grow: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="schedule-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-2"><i class="fas fa-calendar-alt"></i> Lịch làm việc của tôi</h2>
                <p class="mb-0">Xem lịch ca làm việc & quản lý thời gian</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#leaveRequestModal">
                    <i class="fas fa-calendar-times"></i> Đăng ký nghỉ phép
                </button>
            </div>
        </div>
    </div>

    <!-- Current Shift (if working now) -->
    {% if current_shift %}
    <div class="current-shift-card">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="text-success mb-3">
                    <i class="fas fa-clock"></i> Đang trong ca làm việc
                </h4>
                <p class="mb-2"><strong>Ca:</strong> {{ current_shift.get_ca_lam_display }}</p>
                <p class="mb-2"><strong>Thời gian:</strong> {{ current_shift.gio_bat_dau }} - {{ current_shift.gio_ket_thuc }}</p>
                <p class="mb-0"><strong>Đã làm:</strong> <span id="workingTime">0h 0m</span></p>
            </div>
            <div class="col-md-6 text-end">
                <div class="mb-3">
                    <h2 class="text-primary mb-0" id="currentTime"></h2>
                    <small class="text-muted">{{ current_date|date:"l, d/m/Y" }}</small>
                </div>
                <button class="btn btn-success btn-lg" onclick="checkIn()">
                    <i class="fas fa-sign-in-alt"></i> Check In
                </button>
                <button class="btn btn-danger btn-lg" onclick="checkOut()">
                    <i class="fas fa-sign-out-alt"></i> Check Out
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-box">
            <h3 class="text-primary mb-2">{{ total_shifts_month }}</h3>
            <small class="text-muted">Ca làm tháng này</small>
        </div>
        <div class="stat-box">
            <h3 class="text-success mb-2">{{ total_hours_month }}h</h3>
            <small class="text-muted">Tổng giờ làm</small>
        </div>
        <div class="stat-box">
            <h3 class="text-warning mb-2">{{ days_off_month }}</h3>
            <small class="text-muted">Ngày nghỉ</small>
        </div>
        <div class="stat-box">
            <h3 class="text-info mb-2">{{ upcoming_shifts }}</h3>
            <small class="text-muted">Ca sắp tới</small>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="btn-group">
            <button class="btn btn-outline-primary active" id="calendarViewBtn">
                <i class="fas fa-calendar"></i> Lịch
            </button>
            <button class="btn btn-outline-primary" id="timelineViewBtn">
                <i class="fas fa-list"></i> Danh sách
            </button>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-outline-secondary" onclick="previousMonth()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-outline-secondary disabled" id="currentMonth">
                {{ current_month }}
            </button>
            <button class="btn btn-outline-secondary" onclick="nextMonth()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Calendar View -->
    <div class="calendar-view" id="calendarViewSection">
        <div class="calendar-grid">
            <!-- Day headers -->
            <div class="text-center fw-bold text-muted">T2</div>
            <div class="text-center fw-bold text-muted">T3</div>
            <div class="text-center fw-bold text-muted">T4</div>
            <div class="text-center fw-bold text-muted">T5</div>
            <div class="text-center fw-bold text-muted">T6</div>
            <div class="text-center fw-bold text-muted">T7</div>
            <div class="text-center fw-bold text-muted">CN</div>
            
            <!-- Days -->
            {% for day in calendar_days %}
            <div class="calendar-day {% if day.is_today %}today{% endif %} {% if day.has_shift %}has-shift{% endif %} {% if day.is_off %}off-day{% endif %}"
                 onclick="viewDayDetail('{{ day.date }}')">
                <div class="day-number">{{ day.day }}</div>
                {% for shift in day.shifts %}
                <span class="shift-indicator shift-{{ shift.type }}">
                    {{ shift.label }}
                </span>
                {% endfor %}
                {% if day.leave %}
                <span class="badge bg-danger w-100 mt-1">Nghỉ phép</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Legend -->
        <div class="mt-4">
            <small class="text-muted">
                <span class="shift-indicator shift-morning me-2">Sáng</span>
                <span class="shift-indicator shift-afternoon me-2">Chiều</span>
                <span class="shift-indicator shift-evening me-2">Tối</span>
                <span class="shift-indicator shift-fullday me-2">Cả ngày</span>
            </small>
        </div>
    </div>

    <!-- Timeline View -->
    <div class="timeline-view" id="timelineViewSection" style="display: none;">
        <h5 class="mb-3"><i class="fas fa-list"></i> Lịch làm việc chi tiết</h5>
        {% for shift in upcoming_shifts_list %}
        <div class="timeline-item">
            <div class="timeline-time">
                {{ shift.ngay|date:"d/m/Y" }}<br>
                <small class="text-muted">{{ shift.ngay|date:"l" }}</small>
            </div>
            <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <span class="shift-indicator shift-{{ shift.ca_lam }}">
                                {{ shift.get_ca_lam_display }}
                            </span>
                        </h6>
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> {{ shift.gio_bat_dau }} - {{ shift.gio_ket_thuc }}
                        </small>
                    </div>
                    <div>
                        {% if shift.da_check_in %}
                        <span class="badge bg-success">Đã check-in</span>
                        {% endif %}
                        {% if shift.da_check_out %}
                        <span class="badge bg-secondary">Đã check-out</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Chưa có lịch làm việc nào được gán
        </div>
        {% endfor %}
    </div>

    <!-- Leave Requests -->
    <div class="mt-4">
        <h5 class="mb-3"><i class="fas fa-calendar-times"></i> Đơn xin nghỉ của tôi</h5>
        
        {% for leave in my_leave_requests %}
        <div class="leave-request-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-2">
                        {{ leave.tu_ngay|date:"d/m/Y" }} - {{ leave.den_ngay|date:"d/m/Y" }}
                    </h6>
                    <p class="mb-1"><strong>Lý do:</strong> {{ leave.ly_do }}</p>
                    <small class="text-muted">Gửi lúc: {{ leave.ngay_tao|date:"d/m/Y H:i" }}</small>
                </div>
                <div class="text-end">
                    {% if leave.trang_thai == 'pending' %}
                    <span class="badge bg-warning">Chờ duyệt</span>
                    {% elif leave.trang_thai == 'approved' %}
                    <span class="badge bg-success">Đã duyệt</span>
                    {% else %}
                    <span class="badge bg-danger">Từ chối</span>
                    {% endif %}
                    
                    {% if leave.trang_thai == 'pending' %}
                    <br>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelLeave({{ leave.id }})">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    {% endif %}
                </div>
            </div>
            
            {% if leave.trang_thai == 'rejected' and leave.ly_do_tu_choi %}
            <div class="alert alert-danger mt-3 mb-0">
                <strong>Lý do từ chối:</strong> {{ leave.ly_do_tu_choi }}
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Bạn chưa có đơn xin nghỉ nào
        </div>
        {% endfor %}
    </div>
</div>

<!-- Leave Request Modal -->
<div class="modal fade" id="leaveRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-times"></i> Đăng ký nghỉ phép
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="leaveRequestForm">
                    <div class="mb-3">
                        <label class="form-label">Từ ngày: <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fromDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đến ngày: <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="toDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lý do: <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reason" rows="4" required></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Vui lòng đăng ký trước ít nhất 3 ngày để được xem xét
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitLeaveRequest()">
                    <i class="fas fa-paper-plane"></i> Gửi đơn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Day Detail Modal -->
<div class="modal fade" id="dayDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dayDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update current time
function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('vi-VN');
    $('#currentTime').text(timeStr);
}
setInterval(updateTime, 1000);
updateTime();

// View toggle
$('#calendarViewBtn').click(function() {
    $(this).addClass('active');
    $('#timelineViewBtn').removeClass('active');
    $('#calendarViewSection').show();
    $('#timelineViewSection').hide();
});

$('#timelineViewBtn').click(function() {
    $(this).addClass('active');
    $('#calendarViewBtn').removeClass('active');
    $('#calendarViewSection').hide();
    $('#timelineViewSection').show();
});

function previousMonth() {
    // Load previous month
}

function nextMonth() {
    // Load next month
}

function viewDayDetail(date) {
    $('#dayDetailTitle').text('Chi tiết ngày ' + date);
    $('#dayDetailModal').modal('show');
    
    // Load day details via AJAX
    $.ajax({
        url: `/api/schedule/day/${date}/`,
        success: function(data) {
            let html = '';
            if (data.shifts.length > 0) {
                html += '<h6>Ca làm việc:</h6><ul>';
                data.shifts.forEach(shift => {
                    html += `<li>${shift.label}: ${shift.time}</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">Không có ca làm việc</p>';
            }
            $('#dayDetailContent').html(html);
        }
    });
}

function checkIn() {
    if (confirm('Xác nhận check-in vào ca làm việc?')) {
        $.ajax({
            url: '/api/attendance/check-in/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function() {
                alert('Check-in thành công!');
                location.reload();
            }
        });
    }
}

function checkOut() {
    if (confirm('Xác nhận check-out kết thúc ca?')) {
        $.ajax({
            url: '/api/attendance/check-out/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function() {
                alert('Check-out thành công!');
                location.reload();
            }
        });
    }
}

function submitLeaveRequest() {
    const fromDate = $('#fromDate').val();
    const toDate = $('#toDate').val();
    const reason = $('#reason').val();
    
    if (!fromDate || !toDate || !reason) {
        alert('Vui lòng điền đầy đủ thông tin');
        return;
    }
    
    $.ajax({
        url: '/api/leave-requests/',
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: {
            tu_ngay: fromDate,
            den_ngay: toDate,
            ly_do: reason
        },
        success: function() {
            alert('Đã gửi đơn xin nghỉ!');
            $('#leaveRequestModal').modal('hide');
            location.reload();
        },
        error: function(xhr) {
            alert('Có lỗi xảy ra: ' + xhr.responseJSON.message);
        }
    });
}

function cancelLeave(leaveId) {
    if (confirm('Bạn có chắc muốn hủy đơn này?')) {
        $.ajax({
            url: `/api/leave-requests/${leaveId}/`,
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function() {
                alert('Đã hủy đơn!');
                location.reload();
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
