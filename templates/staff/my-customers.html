{% extends 'base.html' %}
{% load static %}

{% block title %}Khách hàng của tôi{% endblock %}

{% block extra_css %}
<style>
    .customer-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        border-left: 4px solid #8b4513;
    }
    
    .customer-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(139, 69, 19, 0.2);
    }
    
    .customer-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .customer-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #8b4513;
    }
    
    .tier-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .tier-bronze { background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%); color: white; }
    .tier-silver { background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%); color: white; }
    .tier-gold { background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%); color: white; }
    .tier-platinum { background: linear-gradient(135deg, #e5e4e2 0%, #b8b6b3 100%); color: #333; }
    
    .customer-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .loyalty-score {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0 auto;
    }
    
    .score-high { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }
    .score-medium { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; }
    .score-low { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); color: white; }
    
    .visit-history {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 15px;
    }
    
    .visit-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.9rem;
    }
    
    .visit-item:last-child {
        border-bottom: none;
    }
    
    .preference-tag {
        display: inline-block;
        padding: 5px 12px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 15px;
        font-size: 0.85rem;
        margin: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-users"></i> Khách hàng của tôi</h2>
            <p class="text-muted mb-0">Danh sách khách hàng đã phục vụ</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-success" onclick="exportCustomers()">
                <i class="fas fa-file-excel"></i> Xuất danh sách
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ total_customers }}</h3>
                    <small class="text-muted">Tổng khách hàng</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success mb-0">{{ regular_customers }}</h3>
                    <small class="text-muted">Khách quen (>5 lần)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info mb-0">{{ this_month_customers }}</h3>
                    <small class="text-muted">Khách tháng này</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning mb-0">{{ avg_rating|floatformat:1 }}/5</h3>
                    <small class="text-muted">Đánh giá TB</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="search" 
                               value="{{ search_query }}"
                               placeholder="Tìm kiếm khách hàng...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="sort">
                            <option value="-last_visit" {% if sort_by == '-last_visit' %}selected{% endif %}>Gặp gần nhất</option>
                            <option value="-visit_count" {% if sort_by == '-visit_count' %}selected{% endif %}>Số lần nhiều nhất</option>
                            <option value="-revenue" {% if sort_by == '-revenue' %}selected{% endif %}>Doanh thu cao nhất</option>
                            <option value="-rating" {% if sort_by == '-rating' %}selected{% endif %}>Đánh giá cao nhất</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="tier">
                            <option value="">Tất cả hạng</option>
                            <option value="bronze" {% if tier_filter == 'bronze' %}selected{% endif %}>Đồng</option>
                            <option value="silver" {% if tier_filter == 'silver' %}selected{% endif %}>Bạc</option>
                            <option value="gold" {% if tier_filter == 'gold' %}selected{% endif %}>Vàng</option>
                            <option value="platinum" {% if tier_filter == 'platinum' %}selected{% endif %}>Bạch kim</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="loyalty">
                            <option value="">Tất cả</option>
                            <option value="high" {% if loyalty_filter == 'high' %}selected{% endif %}>Trung thành cao</option>
                            <option value="medium" {% if loyalty_filter == 'medium' %}selected{% endif %}>Trung thành TB</option>
                            <option value="low" {% if loyalty_filter == 'low' %}selected{% endif %}>Mới</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12 text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Lọc
                        </button>
                        <a href="{% url 'accounts:staff_my_customers' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Xóa bộ lọc
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Customers List -->
    <div class="row">
        {% for customer in customers %}
        <div class="col-md-6">
            <div class="customer-card">
                <div class="customer-header">
                    <img src="{{ customer.anh_dai_dien|default:'/static/img/avatar-default.png' }}" 
                         alt="{{ customer.ho_ten }}" 
                         class="customer-avatar">
                    
                    <div class="flex-grow-1">
                        <h5 class="mb-1">{{ customer.ho_ten }}</h5>
                        <p class="text-muted mb-2">
                            <i class="fas fa-phone"></i> {{ customer.so_dien_thoai }}
                        </p>
                        <span class="tier-badge tier-{{ customer.hang_thanh_vien }}">
                            {% if customer.hang_thanh_vien == 'platinum' %}Bạch kim
                            {% elif customer.hang_thanh_vien == 'gold' %}Vàng
                            {% elif customer.hang_thanh_vien == 'silver' %}Bạc
                            {% else %}Đồng{% endif %}
                        </span>
                    </div>
                    
                    <div class="text-center">
                        {% if customer.loyalty_score >= 80 %}
                        <div class="loyalty-score score-high">{{ customer.loyalty_score }}</div>
                        {% elif customer.loyalty_score >= 50 %}
                        <div class="loyalty-score score-medium">{{ customer.loyalty_score }}</div>
                        {% else %}
                        <div class="loyalty-score score-low">{{ customer.loyalty_score }}</div>
                        {% endif %}
                        <small class="text-muted">Độ trung thành</small>
                    </div>
                </div>
                
                <div class="customer-stats">
                    <div class="stat-item">
                        <h5 class="text-primary mb-0">{{ customer.visit_count }}</h5>
                        <small class="text-muted">Lần cắt</small>
                    </div>
                    <div class="stat-item">
                        <h5 class="text-success mb-0">{{ customer.total_revenue|floatformat:0 }}đ</h5>
                        <small class="text-muted">Doanh thu</small>
                    </div>
                    <div class="stat-item">
                        <h5 class="text-warning mb-0">
                            {{ customer.avg_rating|floatformat:1 }} <i class="fas fa-star"></i>
                        </h5>
                        <small class="text-muted">Đánh giá</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> 
                        Lần cuối: {{ customer.last_visit|date:"d/m/Y" }}
                    </small>
                </div>
                
                <!-- Preferences -->
                {% if customer.preferences %}
                <div class="mt-3">
                    <small class="text-muted d-block mb-2">Sở thích:</small>
                    {% for pref in customer.preferences %}
                    <span class="preference-tag">{{ pref }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Visit History -->
                <div class="visit-history">
                    <small class="text-muted d-block mb-2">Lịch sử phục vụ:</small>
                    {% for visit in customer.recent_visits %}
                    <div class="visit-item">
                        <div class="d-flex justify-content-between">
                            <span>{{ visit.date|date:"d/m/Y" }} - {{ visit.service }}</span>
                            <span class="text-primary">{{ visit.amount|floatformat:0 }}đ</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Actions -->
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-sm btn-primary flex-fill" 
                            onclick="createBooking({{ customer.id }})">
                        <i class="fas fa-calendar-plus"></i> Đặt lịch
                    </button>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="viewDetail({{ customer.id }})">
                        <i class="fas fa-eye"></i> Chi tiết
                    </button>
                    <button class="btn btn-sm btn-outline-success" 
                            onclick="sendMessage({{ customer.id }})">
                        <i class="fas fa-comment"></i>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> Bạn chưa phục vụ khách hàng nào
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if customers.has_other_pages %}
    <nav aria-label="Phân trang" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if customers.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ customers.previous_page_number }}">Trước</a>
            </li>
            {% endif %}

            {% for num in customers.paginator.page_range %}
            <li class="page-item {% if customers.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if customers.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ customers.next_page_number }}">Sau</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Customer Detail Modal -->
<div class="modal fade" id="customerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-circle"></i> Chi tiết khách hàng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerDetailContent">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-submit form when filters change
    $('select[name="sort"], select[name="tier"], select[name="loyalty"]').change(function() {
        $('#filterForm').submit();
    });
    
    // Auto-submit form when search input changes (with delay)
    let searchTimeout;
    $('input[name="search"]').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            $('#filterForm').submit();
        }, 500);
    });
});

function createBooking(customerId) {
    window.location.href = `{% url 'bookings:staff_bookings_create' %}?customer_id=${customerId}`;
}

function viewDetail(customerId) {
    $('#customerDetailModal').modal('show');
    $('#customerDetailContent').html('<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>');
    
    $.ajax({
        url: `/api/customers/${customerId}/detail/`,
        success: function(customer) {
            const html = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="${customer.anh_dai_dien || '/static/img/avatar-default.png'}" 
                             style="width: 150px; height: 150px; border-radius: 50%;">
                        <h4 class="mt-3">${customer.ho_ten}</h4>
                        <p class="text-muted">${customer.so_dien_thoai}</p>
                    </div>
                    <div class="col-md-8">
                        <h6>Thống kê</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>Số lần cắt tóc:</td>
                                <td><strong>${customer.visit_count}</strong></td>
                            </tr>
                            <tr>
                                <td>Tổng doanh thu:</td>
                                <td><strong>${formatCurrency(customer.total_revenue)}</strong></td>
                            </tr>
                            <tr>
                                <td>Đánh giá trung bình:</td>
                                <td><strong>${customer.avg_rating}/5 ⭐</strong></td>
                            </tr>
                        </table>
                        
                        <h6 class="mt-4">Lịch sử giao dịch</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${customer.history.map(h => `
                                <div class="border-bottom py-2">
                                    <strong>${h.date}</strong> - ${h.service}
                                    <span class="text-primary float-end">${formatCurrency(h.amount)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            $('#customerDetailContent').html(html);
        }
    });
}

function sendMessage(customerId) {
    alert('Chức năng gửi tin nhắn đang được phát triển');
}

function exportCustomers() {
    window.location.href = '/staff/my-customers/export/';
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { 
        style: 'currency', 
        currency: 'VND' 
    }).format(amount);
}
</script>
{% endblock %}
